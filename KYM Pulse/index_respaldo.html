
<!DOCTYPE html>
<html lang="es">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KYM Pulse</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
    }
    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding-top: 20px;
    }
    .container {
      width: 90%;
      max-width: 800px;
      background: white;
      padding: 5vw;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
      box-sizing: border-box;
      text-align: center;
    }
    .logo {
      display: block;
      margin-bottom: 20px;
      max-height: 80px;
      max-width: 200px;
    }
    h1 {
      font-size: 24px;
      color: #9920A7;
      margin-bottom: 12px;
    }
    #infoServicio {
      font-weight: 600;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 10px 0 6px;
      font-weight: 500;
    }
    input[type="number"],
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 16px;
      font-size: 15px;
      box-sizing: border-box;
    }
    button {
      background-color: #9920A7;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }
    button:hover {
      background-color: #7c1c87;
    }
    #mensaje {
      margin-top: 20px;
      font-size: 14px;
      color: #666;
      text-align: center;
    }
    .estrella {
      font-size: 36px;
      color: #ccc;
      cursor: pointer;
      margin-right: 8px;
      position: relative;
      display: inline-block;
      transition: transform 0.2s ease-in-out;
    }
    .estrella:hover {
      transform: scale(1.2);
    }
    .estrella.glow::after {
      content: '‚òÖ';
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, #FFB400, transparent);
      background-size: 200%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: glowStar 1.5s linear infinite;
    }
    .estrella.seleccionada {
      color: #FFB400;
    }
    .estrella.seleccionada::after {
      display: none;
    }
    @keyframes glowStar {
      0% { background-position: -100% 0; }
      100% { background-position: 200% 0; }
    }
    #agradecimiento {
      display: none;
      margin-top: 40px;
    }
  
    .fab-whatsapp {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      background-color: #25D366;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 999;
    }
    .fab-whatsapp img {
      width: 100%;
      height: 100%;
      padding: 10%;
      box-sizing: border-box;
    }
    .fab-whatsapp:hover {
      background-color: #1ebe5d;
    }

  
    .fab-whatsapp {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #25D366;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
      z-index: 999;
      transition: transform 0.3s ease;
    }
    .fab-whatsapp img {
      width: 100%;
      height: 100%;
      padding: 10%;
      box-sizing: border-box;
    }
    .fab-whatsapp:hover::after {
      content: "¬°Escr√≠benos y agenda un masaje üòÑ!";
      position: absolute;
      bottom: 60px;
      right: 0;
      background: white;
      color: #333;
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      white-space: nowrap;
    }
    .fab-whatsapp:hover {
      transform: scale(1.05);
      background-color: #1ebe5d;
    }

    .estrella.seleccionada {
      color: #FFB400;
      animation: bounceStar 0.2s ease;
    }

    @keyframes bounceStar {
      0% { transform: scale(1); }
      50% { transform: scale(1.4); }
      100% { transform: scale(1); }
    }

  
    .estrella.boom {
      animation: boomFeedback 0.3s ease;
    }
    @keyframes boomFeedback {
      0% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.6); filter: brightness(1.4); }
      100% { transform: scale(1); filter: brightness(1); }
    }
    .tooltip-boom {
      position: absolute;
      top: -32px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      color: #9920A7;
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      white-space: nowrap;
      animation: fadeOutTooltip 1s forwards;
      pointer-events: none;
      z-index: 1000;
    }
    @keyframes fadeOutTooltip {
      0% { opacity: 1; }
      100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

  
    .estrella.idle-glow {
      animation: pulseStar 2.5s ease-in-out infinite;
    }
    @keyframes pulseStar {
      0%, 100% { transform: scale(1); opacity: 0.85; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    #chipFeedback {
      display: none;
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #9920A7;
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
      animation: chipFade 2s forwards;
    }
    @keyframes chipFade {
      0% { opacity: 0; transform: translateY(10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translateY(-10px); }
    }
    #celebration {
      display: none;
      font-size: 40px;
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translateX(-50%) scale(0.8);
      animation: celebrationBounce 1.2s ease forwards;
      z-index: 1000;
    }
    @keyframes celebrationBounce {
      0% { opacity: 0; transform: translateX(-50%) scale(0.6); }
      40% { opacity: 1; transform: translateX(-50%) scale(1.3); }
      100% { opacity: 0; transform: translateX(-50%) scale(0.5); }
    }

  </style>
</head>
<body>
  <div class="wrapper">
    <img src="assets/images/logo.png" alt="Fisio Spa KYM" class="logo" />
    <div class="container">
      <h1>Registro de Servicio</h1>
      <div id="infoServicio">Cargando datos...</div>
      <div id="step1">
        <label for="empleado">N√∫mero de empleado (obligatorio)</label>
        <input type="number" id="empleado" placeholder="Ej. 12456" required />
        <button id="confirmarEmpleado">Confirmar</button>
      </div>
      <form id="formEncuesta" style="display:none;"></form>
      <div id="agradecimiento">
        <h2>üéâ ¬°Gracias por tu tiempo!</h2>
        <p>Tu respuesta fue registrada exitosamente.</p>
        <p>Ser√°s redirigido en unos segundos...</p>
      </div>
      <div id="mensaje"></div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
    import {
      getFirestore, collection, addDoc, getDoc, getDocs,
      serverTimestamp, query, limit, updateDoc, doc
    } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA2JYgF-4RGvlXe1A-QTTd3qAd0IoaYqLM",
      authDomain: "fisiospakym-afff6.firebaseapp.com",
      projectId: "fisiospakym-afff6",
      storageBucket: "fisiospakym-afff6.appspot.com",
      messagingSenderId: "468567229058",
      appId: "1:468567229058:web:7aa7d697ed61cd89fc46df"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const params = new URLSearchParams(window.location.search);
    const eventoId = params.get("e");
    const profesionalId = params.get("p");
    const servicioId = params.get("s");

    const infoServicio = document.getElementById("infoServicio");
    const form = document.getElementById("formEncuesta");
    const mensaje = document.getElementById("mensaje");
    const inputEmpleado = document.getElementById("empleado");
    const btnConfirmar = document.getElementById("confirmarEmpleado");
    const step1 = document.getElementById("step1");
    const agradecimiento = document.getElementById("agradecimiento");

    let nombreProf = profesionalId;
    let nombreServ = servicioId;
    let docRef = null;
    let numeroEmpleado = null;

    function alerta(texto) {
      mensaje.innerText = "üõ†Ô∏è " + texto;
    }

    async function cargarInfoSuperior() {
      try {
        const docProf = await getDoc(doc(db, 'profesionales', profesionalId));
        const docServ = await getDoc(doc(db, 'services', servicioId));
        if (docProf.exists()) nombreProf = docProf.data().nombre;
        if (docServ.exists()) nombreServ = docServ.data().name;
      } catch (err) {
        alerta("Error cargando nombres: " + err.message);
      }
      infoServicio.innerHTML = `Esperamos que tu servicio de <span style="color: #9920A7; font-weight: 600;">"${nombreServ}"</span> haya sido de tu agrado. Te atendi√≥ <span style="color: #9920A7; font-weight: 600;">${nombreProf}</span>. Por favor, ingresa tu n√∫mero de empleado para registrar tu servicio.`;
    }

    async function registrarEscaneo() {
      try {
        numeroEmpleado = inputEmpleado.value.trim();
        if (!numeroEmpleado) {
          alerta("‚ö†Ô∏è Debes ingresar tu n√∫mero de empleado antes de continuar.");
          inputEmpleado.focus();
          return;
        }
        const ref = collection(db, 'eventos', eventoId, 'registros');
        docRef = await addDoc(ref, {
          servicioId, profesionalId, eventoId,
          fecha: serverTimestamp(),
          numeroEmpleado,
          completado: false,
          plataforma: navigator.platform,
          userAgent: navigator.userAgent,
        });
        alerta("‚úÖ N√∫mero confirmado. Por favor responde la encuesta.");
        step1.style.display = 'none';
        form.style.display = 'block';
        document.getElementById("fabWhatsapp").style.display = 'block';  // ‚úÖ CAMBIO: Mostrar FAB de WhatsApp con √≠cono
        infoServicio.innerText = "üí¨ Ay√∫danos respondiendo la siguiente encuesta para seguir mejorando tu experiencia.";
        await cargarEncuesta();
      } catch (err) {
        alerta("‚ùå ERROR guardando escaneo: " + err.message);
      }
    }

    async function cargarEncuesta() {
      const snap = await getDocs(query(collection(db, 'encuestas'), limit(1)));
      if (snap.empty) return alerta("‚ùå No hay encuesta configurada");
      const data = snap.docs[0].data();
      form.innerHTML = '';
      data.preguntas.forEach((p, i) => {
        const name = `preg${i}`;
        form.innerHTML += `
          <label>${p.texto}</label>
          <div class="rating" data-name="${name}">
            ${[1,2,3,4,5].map(n => `<span class="estrella glow" data-value="${n}">&#9733;</span>`).join('')}
          </div>`;
      });
      form.innerHTML += `
        <label>Comentario adicional (opcional)</label>
        <textarea name="comentario" rows="3" placeholder="Escribe algo..."></textarea>
        <button type="submit">Enviar encuesta</button>`;
      form.querySelectorAll('.rating').forEach(rating => {
        rating.querySelectorAll('.estrella').forEach(e => e.classList.add('idle-glow'));
        const name = rating.dataset.name;
        rating.querySelectorAll('.estrella').forEach(estrella => {
          estrella.addEventListener('click', () => {
              navigator.vibrate?.([20, 20, 20]);  // ‚úÖ CAMBIO: vibraci√≥n h√°ptica intensificada
              estrella.classList.add('boom');
              const tooltip = document.createElement('div');
              tooltip.className = 'tooltip-boom';
              tooltip.textContent = '¬°Gracias!';
              estrella.appendChild(tooltip);
              setTimeout(() => {
                estrella.classList.remove('boom');
                estrella.removeChild(tooltip);
              }, 1000);
            const val = parseInt(estrella.dataset.value);
            rating.querySelectorAll('.estrella').forEach(e => {
                e.classList.remove('idle-glow');
              e.classList.toggle('seleccionada', parseInt(e.dataset.value) <= val);
              e.classList.remove('glow');
            });
            rating.dataset.valor = val;
          });
        });
      });
    }

    async function guardarEncuesta(data) {
      if (!docRef) return alerta("‚ùå Registro inv√°lido");
      document.querySelectorAll('.rating').forEach(rating => {
        const name = rating.dataset.name;
        const val = parseInt(rating.dataset.valor || "0");
        data[name] = val;
      });
      await updateDoc(docRef, { completado: true, encuesta: data });
      form.style.display = 'none';
        const celebration = document.getElementById("celebration");
        if (celebration) {
          celebration.style.display = "block";
          setTimeout(() => {
            celebration.style.display = "none";
          }, 1200);
        }
      agradecimiento.style.display = 'block';
      infoServicio.style.display = 'none';
      step1.style.display = 'none';
      mensaje.innerText = '';
      setTimeout(() => {
        window.location.href = "https://www.fisiospakym.com";
      }, 5000);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {};
      new FormData(form).forEach((val, key) => (data[key] = val));
      await guardarEncuesta(data);
    });

    if (eventoId && profesionalId && servicioId) {
      await cargarInfoSuperior();
    } else {
      alerta("‚ùå Faltan par√°metros en la URL");
    }

    btnConfirmar.addEventListener("click", registrarEscaneo);
  </script>

  <a id="fabWhatsapp" href="https://wa.me/525544818100" target="_blank" class="fab-whatsapp" title="¬øDudas? Escr√≠benos por WhatsApp üí¨">
    <img src="assets/images/whatsapp-icon.png" alt="WhatsApp" />
  </a>


  <div id="chipFeedback">Tu calificaci√≥n ha sido registrada ‚úÖ</div>
  <div id="celebration">üéâ</div>
</body>

</html>
